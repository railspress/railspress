<% content_for :title, "GDPR User Management" %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-white">User Data Management</h1>
        <p class="mt-2 text-gray-400">Manage user data exports, erasures, and consent for GDPR compliance</p>
      </div>
      <div class="flex space-x-3">
        <%= link_to admin_gdpr_index_path, class: "bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          <span>Back to Dashboard</span>
        <% end %>
        <%= link_to admin_gdpr_compliance_path, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>Compliance Report</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
    <%= form_with url: admin_gdpr_users_path, method: :get, local: true, class: "space-y-4" do |form| %>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <%= form.label :search, "Search Users", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.text_field :search, value: params[:search], placeholder: "Search by email or name...", class: "w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= form.label :filter, "Filter", class: "block text-sm font-medium text-gray-300 mb-2" %>
          <%= form.select :filter, [
            ['All Users', ''],
            ['Users with Export Requests', 'with_exports'],
            ['Users with Erasure Requests', 'with_erasures'],
            ['Users with Consent Records', 'with_consent']
          ], { selected: params[:filter] }, { class: "w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
        </div>
        <div class="flex items-end">
          <%= form.submit "Search", class: "bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg" %>
          <%= link_to admin_gdpr_users_path, class: "ml-2 bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg" do %>
            Clear
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Bulk Actions -->
  <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
    <h3 class="text-lg font-semibold text-white mb-4">Bulk Actions</h3>
    <%= form_with url: admin_gdpr_bulk_export_path, method: :post, local: true, id: "bulk-export-form" do |form| %>
      <div class="flex items-center space-x-4">
        <button type="button" id="select-all-users" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
          Select All
        </button>
        <button type="button" id="clear-selection" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
          Clear Selection
        </button>
        <button type="submit" id="bulk-export-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" disabled>
          Export Selected (<span id="selected-count">0</span>)
        </button>
      </div>
    <% end %>
  </div>

  <!-- Users Table -->
  <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-gray-700">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
              <input type="checkbox" id="select-all-checkbox" class="rounded border-gray-600 text-blue-600 focus:ring-blue-500">
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">User</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Data Summary</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Export Requests</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Erasure Requests</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Consent Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-gray-800 divide-y divide-gray-700">
          <% @users.each do |user| %>
            <tr class="hover:bg-gray-700">
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="checkbox" name="user_ids[]" value="<%= user.id %>" class="user-checkbox rounded border-gray-600 text-blue-600 focus:ring-blue-500">
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-gray-600 flex items-center justify-center">
                      <span class="text-sm font-medium text-white"><%= user.email.first.upcase %></span>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-white"><%= user.email %></div>
                    <div class="text-sm text-gray-400"><%= user.name.present? ? user.name : 'No name' %></div>
                    <div class="text-xs text-gray-500">Joined <%= time_ago_in_words(user.created_at) %> ago</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                <div class="space-y-1">
                  <div>Posts: <%= user.posts.size %></div>
                  <div>Comments: <%= @comment_counts[user.email] || 0 %></div>
                  <div>Media: <%= user.media.size %></div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                <% if user.personal_data_export_requests.any? %>
                  <div class="space-y-1">
                    <% user.personal_data_export_requests.recent.limit(3).each do |request| %>
                      <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs rounded-full <%= case request.status
                          when 'completed' then 'bg-green-600 text-white'
                          when 'processing' then 'bg-yellow-600 text-white'
                          when 'pending' then 'bg-blue-600 text-white'
                          else 'bg-gray-600 text-white'
                        end %>">
                          <%= request.status.titleize %>
                        </span>
                        <span class="text-xs text-gray-400"><%= time_ago_in_words(request.created_at) %> ago</span>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <span class="text-gray-500">None</span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                <% if user.personal_data_erasure_requests.any? %>
                  <div class="space-y-1">
                    <% user.personal_data_erasure_requests.recent.limit(3).each do |request| %>
                      <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs rounded-full <%= case request.status
                          when 'completed' then 'bg-green-600 text-white'
                          when 'processing' then 'bg-yellow-600 text-white'
                          when 'pending_confirmation' then 'bg-red-600 text-white'
                          else 'bg-gray-600 text-white'
                        end %>">
                          <%= request.status.humanize %>
                        </span>
                        <span class="text-xs text-gray-400"><%= time_ago_in_words(request.created_at) %> ago</span>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <span class="text-gray-500">None</span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                <% if user.user_consents.any? %>
                  <div class="space-y-1">
                    <% user.user_consents.recent.limit(3).each do |consent| %>
                      <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 text-xs rounded-full <%= consent.granted? ? 'bg-green-600 text-white' : 'bg-red-600 text-white' %>">
                          <%= consent.consent_type.titleize %>
                        </span>
                        <span class="text-xs text-gray-400"><%= consent.granted? ? 'Granted' : 'Withdrawn' %></span>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <span class="text-gray-500">No consent records</span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center space-x-2">
                  <%= link_to admin_gdpr_user_data_path(user), class: "text-blue-400 hover:text-blue-300" do %>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                  <% end %>
                  <%= link_to admin_gdpr_user_consent_history_path(user), class: "text-green-400 hover:text-green-300" do %>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <% if @users.respond_to?(:current_page) %>
    <div class="mt-8 flex items-center justify-between">
      <div class="text-sm text-gray-400">
        Showing <%= @users.offset_value + 1 %> to <%= [@users.offset_value + @users.limit_value, @users.total_count].min %> of <%= @users.total_count %> users
      </div>
      <div class="flex space-x-2">
        <%= paginate @users %>
      </div>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  const userCheckboxes = document.querySelectorAll('.user-checkbox');
  const selectedCountSpan = document.getElementById('selected-count');
  const bulkExportBtn = document.getElementById('bulk-export-btn');
  const selectAllBtn = document.getElementById('select-all-users');
  const clearSelectionBtn = document.getElementById('clear-selection');

  function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.user-checkbox:checked').length;
    selectedCountSpan.textContent = selectedCount;
    bulkExportBtn.disabled = selectedCount === 0;
  }

  function updateSelectAllState() {
    const checkedCount = document.querySelectorAll('.user-checkbox:checked').length;
    selectAllCheckbox.checked = checkedCount === userCheckboxes.length;
    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < userCheckboxes.length;
  }

  selectAllCheckbox.addEventListener('change', function() {
    userCheckboxes.forEach(checkbox => {
      checkbox.checked = this.checked;
    });
    updateSelectedCount();
  });

  userCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateSelectedCount();
      updateSelectAllState();
    });
  });

  selectAllBtn.addEventListener('click', function() {
    userCheckboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
    updateSelectedCount();
  });

  clearSelectionBtn.addEventListener('click', function() {
    userCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
    updateSelectedCount();
  });

  updateSelectedCount();
  updateSelectAllState();
});
</script>
