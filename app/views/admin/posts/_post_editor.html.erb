<%= render 'admin/posts/write_styles' %>

<script>
// Theme initialization
(function() {
  try {
    var saved = localStorage.getItem('theme');
    var useDark = saved ? saved === 'dark' : true; // default dark
    if (useDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
    
    // Dispatch theme event for theme-aware components
    document.dispatchEvent(new CustomEvent('theme:changed', { 
      detail: { theme: useDark ? 'dark' : 'light' } 
    }));
  } catch (e) {
    // On any error, default to dark
    document.documentElement.classList.add('dark');
    document.dispatchEvent(new CustomEvent('theme:changed', { 
      detail: { theme: 'dark' } 
    }));
  }
})();
</script>

<div class="h-screen flex flex-col sidebar-collapsed overflow-hidden" data-controller="keyboard-shortcuts" style="background-color: var(--admin-bg-app);">
  
  <!-- Ultra Minimal Top Bar (Full Width) - Fixed at top -->
  <div class="px-6 py-3 flex items-center justify-between fixed top-0 left-0 right-0 z-50" style="border-bottom: 1px solid var(--admin-border); background-color: var(--admin-bg-primary);">
        <%= link_to admin_posts_path, class: "flex items-center gap-2 transition-colors duration-200 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300", style: "", onmouseover: "", onmouseout: "" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
          </svg>
          <span class="text-sm font-medium">Posts</span>
        <% end %>
        
        <div class="flex items-center gap-4">
          <!-- Autosave Indicator -->
          <div class="flex items-center gap-2">
            <div class="autosave-indicator flex items-center gap-2 text-xs text-gray-400 dark:text-gray-500">
              <!-- Spinning loader -->
              <svg class="w-3 h-3 animate-spin text-blue-500 hidden" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <!-- Checkmark -->
              <svg class="w-3 h-3 text-green-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
              </svg>
              <span class="autosave-text"></span>
            </div>
          </div>
          
          <!-- AI Assistant Button -->
          <button type="button" 
                  class="p-1.5 rounded-lg transition-colors duration-200"
                  style="background-color: transparent; color: var(--color-gray-500);"
                  onmouseover="this.style.backgroundColor='var(--color-gray-100)'"
                  onmouseout="this.style.backgroundColor='transparent'"
                  onclick="toggleAiSidebar(event)"
                  title="AI Assistant">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"/>
            </svg>
          </button>
          
          <!-- Preview Link -->
          <a href="<%= @post.preview_url %>" 
             target="_blank"
             class="p-1.5 rounded-lg transition-colors duration-200"
             style="background-color: transparent; color: var(--color-gray-500);"
             onmouseover="this.style.backgroundColor='var(--color-gray-100)'"
             onmouseout="this.style.backgroundColor='transparent'"
             title="View post">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"/>
            </svg>
          </a>
          
          <!-- Theme Toggle -->
          <button type="button" 
                  data-controller="theme-toggle" 
                  data-action="click->theme-toggle#toggle"
                  class="p-1.5 rounded-lg transition-colors duration-200"
                  style="background-color: transparent; color: var(--color-gray-500);"
                  onmouseover="this.style.backgroundColor='var(--color-gray-100)'"
                  onmouseout="this.style.backgroundColor='transparent'">
            <svg class="w-4 h-4 theme-icon-moon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" style="display: none;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
            </svg>
            <svg class="w-4 h-4 theme-icon-sun" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" style="display: block;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/>
            </svg>
          </button>
          
          
          
          <!-- Small Save Button - Floppy Icon -->
          <button type="button" 
                  class="p-1.5 rounded-lg transition-all duration-200 save-button"
                  data-action="click->autosave#saveNow"
                  data-autosave-target="saveButton"
                  style="background-color: transparent; color: var(--color-gray-500);"
                  onmouseover="this.style.backgroundColor='var(--color-gray-100)'"
                  onmouseout="this.style.backgroundColor='transparent'"
                  title="Save">
            <!-- Floppy Icon -->
            <svg class="w-4 h-4" data-autosave-target="saveIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0120.25 6v12A2.25 2.25 0 0118 20.25H6A2.25 2.25 0 013.75 18V6A2.25 2.25 0 016 3.75h1.5m9 0h-9"/>
            </svg>
            
            <!-- Circular Progress Indicator -->
            <svg class="w-4 h-4 hidden animate-spin" data-autosave-target="saveSpinner" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>

          <!-- Sidebar Toggle Button (topbar) -->
          <button type="button" 
                  class="p-1.5 rounded-lg transition-colors duration-200 sidebar-toggle-topbar"
                  style="background-color: transparent; color: var(--color-gray-500);"
                  onmouseover="this.style.backgroundColor='var(--color-gray-100)'"
                  onmouseout="this.style.backgroundColor='transparent'"
                  onclick="window.dispatchEvent(new CustomEvent('toggle-sidebar'))">
            <svg class="w-4 h-4" data-sidebar-target="toggleIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/>
            </svg>
          </button>
        </div>
  </div>
  
  <%= form_with model: @post, url: @post.persisted? ? admin_post_path(@post) : admin_posts_path, class: "flex-1 flex flex-col overflow-hidden", data: { controller: "autosave slug-generator", autosave_url_value: @post.persisted? ? admin_post_path(@post) : admin_posts_path, autosave_interval_value: SiteSetting.get('auto_save_interval', 60) * 1000, autosave_target: "form", slug_generator_persisted_value: @post.persisted?, slug_generator_status_value: @post.status, post_id: @post.persisted? ? @post.id : 'new' } do |f| %>
    
    <!-- Main Content Area (Editor + Sidebar) -->
    <div class="flex-1 flex overflow-hidden" 
         style="margin-top: 50px; height: calc(100vh - 50px);"
         data-controller="split-panels"
         data-action="split-panels:toggle-left@window->split-panels#toggleLeftPanel split-panels:toggle-right@window->split-panels#toggleRightPanel">
      <!-- Left Sidebar: AI Assistant -->
      <div class="ai-left-sidebar"
           data-controller="ai-sidebar"
           data-ai-sidebar-collapsed-value="true"
           data-split-panels-target="leftPanel"
           data-split-panel="left"
           style="border-right: 1px solid var(--admin-border); background-color: var(--admin-bg-primary); overflow: hidden;">
        
        <div class="ai-sidebar-content h-full w-full" data-ai-sidebar-target="content" style="opacity: 0; pointer-events: none;">
          <%= render 'shared/ai_chat_widget',
              agent_slug: 'post_writer',
              allow_agent_switch: true,
              height: '100%',
              recall_conversation: true,
              show_greeting: false,
              show_settings: true,
              add_content: true,
              allow_attachments: true,
              title: 'Post Writer',
              display_html_raw: true,
              show_close_button: true,
              close_button_callback:  'toggleAiSidebar',
              background_color: 'var(--admin-bg-primary)',
              header_color: 'var(--admin-bg-primary)',
              textbar_color: 'var(--admin-bg-primary)',
              user_bubble_color: 'var(--admin-primary)',
              agent_bubble_color: 'var(--admin-bg-secondary)',
              accent_color: 'var(--admin-bg-tertiary)'
          %>
          <style>
            /* Override chat widget CSS variables to use theme colors */
            .ai-chat-widget {
              --chat-text: var(--admin-text-primary);
              --chat-text-muted: var(--admin-text-tertiary);
              --chat-border: var(--admin-border);
              --chat-accent: var(--admin-primary);
            }
            
            /* Send button should have proper contrast */
            .ai-chat-widget .ai-chat-send {
              background: var(--admin-primary) !important;
              color: white !important;
              border-top-left-radius: 0 !important;
              border-bottom-left-radius: 0 !important;
            }
            
            /* Bot avatar should use primary color */
            .ai-chat-widget .ai-chat-message.agent .ai-chat-avatar {
              background: var(--admin-primary) !important;
              color: white !important;
            }
          </style>
        </div>
      </div>
      
      <!-- Middle: Main Editor Area -->
      <div class="flex-1 flex flex-col overflow-hidden" data-split-panels-target="middlePanel" data-split-panel="middle">
        <!-- Title + Editor Container -->
        <div class="flex-1 overflow-y-auto">
        <div class="ml-0 px-8 py-12">

        <div class="post-title-container">
          <!-- Title Input -->
          <%= f.text_area :title, 
              value: (@post.auto_draft_status? && @post.title == 'Untitled') ? '' : @post.title,
              class: "w-full bg-transparent text-gray-900 dark:text-white text-6xl font-bold placeholder-gray-300 dark:placeholder-gray-600 border-none outline-none focus:ring-0 mb-6 leading-tight resize-none",
              placeholder: "Untitled",
              autofocus: !@post.persisted?,
              rows: 1,
              data: { autosave_target: "title", slug_generator_target: "title", action: "input->slug-generator#generateSlug" } %>
        </div>
          
          <!-- Content Editor (Dynamic based on user preference) -->
          <div style="min-height: calc(100vh - 30px) !important;">
            <%= render 'shared/content_editor_simple', 
                form: f,
                content: @post.content_json.presence || @post.content.to_s,
                field_name: :content,
                placeholder: 'Start writing...',
                editor_type: current_user&.editor_preference || 'editorjs' %>
          </div>
          
          <!-- Subtle Meta (below editor for edit pages) -->
          <% if @post.persisted? && !@post.auto_draft_status? %>
            <div class="flex items-center gap-3 text-sm mt-6" style="color: var(--admin-text-tertiary);">
              <span>Last edited <%= time_ago_in_words(@post.updated_at) %> ago</span>
              <span>â€¢</span>
              <span><%= @post.user&.name || 'Anonymous' %></span>
            </div>
          <% end %>
          
          <!-- Hidden fields -->
          <%= f.hidden_field :user_id, value: current_user.id %>
        </div>
        </div>
      </div>
    
      <!-- Right Sidebar: Settings -->
      <div class="sidebar-scroll" 
           data-controller="sidebar" 
           data-action="toggle-sidebar@window->sidebar#toggle" 
           data-sidebar-collapsed-value="true" 
           data-split-panels-target="rightPanel"
           data-split-panel="right"
           style="border-left: 1px solid var(--admin-border); background-color: var(--admin-bg-primary); overflow: hidden;">
      
      <div class="p-6 space-y-8 h-full overflow-y-auto" data-sidebar-target="content" data-controller="sidebar-reorder" data-sidebar-reorder-user-id-value="<%= current_user.id %>" data-sidebar-reorder-target="container">
        
        <%= render 'admin/posts/sidebar_sections/post', f: f %>
        
        <%= render 'admin/posts/sidebar_sections/categories_tags', f: f %>
        
        <%= render 'admin/posts/sidebar_sections/seo_meta', f: f %>
        
        <%= render 'admin/posts/sidebar_sections/content_channels', f: f %>
        
        <%= render 'admin/posts/sidebar_sections/excerpt', f: f %>
        
        <%= render 'admin/posts/sidebar_sections/post_info' %>
        
        <%= render 'admin/posts/sidebar_sections/versions' %>
        
        <% if plugin_blocks_present?(:post, position: :sidebar, record: @post) %>
          <%= render 'admin/posts/sidebar_sections/plugin_blocks', f: f %>
        <% end %>
        
      </div>
    </div>
    </div>
  <% end %>
</div>

<%= render 'admin/posts/keyboard_shortcuts' %>

<script>
// Auto-grow title textarea
(function() {
  const titleInput = document.querySelector('textarea[name*="title"]');
  if (titleInput) {
    // Auto-resize on input
    titleInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });
    
    // Initial resize
    titleInput.style.height = 'auto';
    titleInput.style.height = titleInput.scrollHeight + 'px';
  }
})();

// Global function to insert AI content into editor
window.insertAiContentToEditor = async function(content) {
  const editorWrapper = document.querySelector('[data-editor-type]');
  const editorType = editorWrapper ? editorWrapper.dataset.editorType : null;
  
  if (editorType === 'editorjs') {
    const editorjsElement = document.querySelector('[data-controller*="editorjs"]');
    if (editorjsElement) {
      const controller = window.Stimulus.getControllerForElementAndIdentifier(editorjsElement, 'editorjs');
      if (controller && controller.editor) {
        try {
          const { htmlToEditorJS } = await import('editorjs_converter');
          const editorJSData = htmlToEditorJS(content);
          await controller.editor.render(editorJSData);
          
          if (controller.saveContent) {
            await controller.saveContent();
          }
          return true;
        } catch (error) {
          console.error('EditorJS insertion failed:', error);
          return false;
        }
      }
    }
  } else if (editorType === 'trix') {
    const trixEditor = document.querySelector('trix-editor');
    if (trixEditor) {
      trixEditor.editor.loadHTML(content);
      return true;
    }
  } else if (editorType === 'ckeditor5') {
    const ckElement = document.querySelector('[data-controller*="ckeditor5"]');
    if (ckElement) {
      const controller = window.Stimulus.getControllerForElementAndIdentifier(ckElement, 'ckeditor5');
      if (controller && controller.editor) {
        controller.editor.setData(content);
        return true;
      }
    }
  }
  
  return false;
}

// Global function to toggle AI sidebar
window.toggleAiSidebar = function(event) {
  if (event) event.preventDefault();
  const sidebar = document.querySelector('[data-controller="ai-sidebar"]');
  if (sidebar) {
    const controller = window.Stimulus.getControllerForElementAndIdentifier(sidebar, 'ai-sidebar');
    if (controller) {
      controller.toggle();
    }
  }
}
</script>
