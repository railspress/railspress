<% content_for :title, @post.persisted? ? "Edit - #{@post.title}" : "New Post" %>

<style>
.ce-block__content {
  margin: 0 !important;
}

/* Hide sidebar initially to prevent flash */
[data-sidebar-collapsed-value="true"] {
  width: 0px !important;
  overflow: hidden !important;
}

[data-sidebar-collapsed-value="true"] [data-sidebar-target="content"] {
  opacity: 0 !important;
  pointer-events: none !important;
}

/* When sidebar is collapsed, expand main content to full width */
.sidebar-collapsed [data-sidebar-collapsed-value="true"] {
  width: 0px !important;
  overflow: hidden !important;
}

.sidebar-collapsed .flex-1.flex.overflow-hidden > .flex-1.flex.flex-col.overflow-hidden {
  width: 100% !important;
  max-width: 100% !important;
}

.sidebar-collapsed .max-w-4xl.mx-auto.px-8.py-12 {
  max-width: 100% !important;
  padding-left: 3rem !important;
  padding-right: 3rem !important;
}

/* Theme variables (use global admin vars) */
:root {
  --input-bg: var(--admin-bg-primary);
  --input-border: var(--admin-border);
  --input-text: var(--admin-text-primary);
}

/* Unified form control styling via vars */
.form-control {
  background-color: var(--input-bg) !important;
  border: 1px solid var(--input-border) !important;
  color: var(--input-text) !important;
}

/* Save Button Styles - Inverted colors for light/dark themes */
.save-button {
  background-color: var(--color-gray-800) !important;
  color: var(--color-gray-200) !important;
  border: 1px solid var(--color-gray-600) !important;
}

.save-button:hover {
  background-color: var(--color-gray-700) !important;
  color: white !important;
}

/* Light theme overrides */
[data-theme="light"] .save-button {
  background-color: var(--color-gray-100) !important;
  color: var(--color-gray-800) !important;
  border: 1px solid var(--color-gray-300) !important;
}

[data-theme="light"] .save-button:hover {
  background-color: var(--color-gray-200) !important;
  color: var(--color-gray-900) !important;
}
</style>
<script>
(function() {
  try {
    var saved = localStorage.getItem('theme');
    var useDark = saved ? saved === 'dark' : true; // default dark
    if (useDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  } catch (e) {
    // On any error, default to dark
    document.documentElement.classList.add('dark');
  }
})();
</script>
<div class="h-screen flex flex-col sidebar-collapsed" data-controller="keyboard-shortcuts" style="background-color: var(--admin-bg-app);">
  
  <%= form_with model: @post, url: @post.persisted? ? admin_post_path(@post) : admin_posts_path, class: "flex-1 flex flex-col", data: { controller: "autosave slug-generator", autosave_url_value: @post.persisted? ? admin_post_path(@post) : admin_posts_path, autosave_target: "form", slug_generator_persisted_value: @post.persisted? } do |f| %>
    
    <!-- Ultra Minimal Top Bar (Full Width) -->
    <div class="px-6 py-3 flex items-center justify-between" style="border-bottom: 1px solid var(--admin-border); background-color: var(--admin-bg-primary);">
        <%= link_to admin_posts_path, class: "flex items-center gap-2 transition-colors duration-200 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300", style: "", onmouseover: "", onmouseout: "" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
          </svg>
          <span class="text-sm font-medium">Posts</span>
        <% end %>
        
        <div class="flex items-center gap-4">
          <!-- Autosave Indicator -->
          <div class="flex items-center gap-2">
            <div class="autosave-indicator flex items-center gap-2 text-xs text-gray-400 dark:text-gray-500">
              <!-- Spinning loader -->
              <svg class="w-3 h-3 animate-spin text-blue-500 hidden" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <!-- Checkmark -->
              <svg class="w-3 h-3 text-green-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
              </svg>
              <span class="autosave-text">All changes saved</span>
            </div>
          </div>
          
          
          <!-- Theme Toggle -->
          <button type="button" 
                  data-controller="theme-toggle" 
                  data-action="click->theme-toggle#toggle"
                  class="p-1.5 rounded-lg transition-colors duration-200"
                  style="background-color: transparent; color: var(--color-gray-500);"
                  onmouseover="this.style.backgroundColor='var(--color-gray-100)'"
                  onmouseout="this.style.backgroundColor='transparent'">
            <svg class="w-4 h-4 theme-icon-moon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" style="display: none;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
            </svg>
            <svg class="w-4 h-4 theme-icon-sun" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" style="display: block;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/>
            </svg>
          </button>
          
          
          
          <!-- Small Save Button -->
          <button type="button" 
                  class="px-2 py-1 text-xs font-medium rounded-md transition-colors duration-200 save-button"
                  onclick="document.querySelector('[data-controller*=\"autosave\"]').dispatchEvent(new CustomEvent('save'))">
            Save
          </button>

          <!-- Sidebar Toggle Button (topbar) -->
          <button type="button" 
                  class="p-1.5 rounded-lg transition-colors duration-200 sidebar-toggle-topbar"
                  style="background-color: transparent; color: var(--color-gray-500);"
                  onmouseover="this.style.backgroundColor='var(--color-gray-100)'"
                  onmouseout="this.style.backgroundColor='transparent'"
                  onclick="window.dispatchEvent(new CustomEvent('toggle-sidebar'))">
            <svg class="w-4 h-4" data-sidebar-target="toggleIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/>
            </svg>
          </button>
        </div>
    </div>
    
    <!-- Main Content Area (Editor + Sidebar) -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Left: Main Editor Area -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Title + Editor Container -->
        <div class="flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto px-8 py-12">
          <!-- Title Input -->
          <%= f.text_field :title, 
              class: "w-full bg-transparent text-gray-900 dark:text-white text-6xl font-bold placeholder-gray-300 dark:placeholder-gray-600 border-none outline-none focus:ring-0 mb-6 leading-tight",
              placeholder: "Untitled",
              autofocus: !@post.persisted?,
              data: { autosave_target: "title", slug_generator_target: "title", action: "input->slug-generator#generateSlug" } %>
          
          <!-- Subtle Meta -->
          <% if @post.persisted? %>
            <div class="flex items-center gap-3 text-sm" style="color: var(--admin-text-tertiary);">
              <span>Last edited <%= time_ago_in_words(@post.updated_at) %> ago</span>
              <span>â€¢</span>
              <span><%= @post.author_name %></span>
            </div>
          <% end %>
          
          <!-- Content Editor (Dynamic based on user preference) -->
          <div class="min-h-[calc(100vh-300px)]">
            <%= render 'shared/content_editor_simple', 
                form: f,
                content: @post.content,
                field_name: :content,
                placeholder: 'Start writing...',
                editor_type: current_user&.preferred_editor || 'blocknote' %>
          </div>
          
          <!-- Hidden fields -->
          <%= f.hidden_field :user_id, value: current_user.id %>
        </div>
        </div>
      </div>
    
      <!-- Right Sidebar: Settings -->
      <div class="w-80 transition-all duration-300 sidebar-scroll" data-controller="sidebar" data-action="toggle-sidebar@window->sidebar#toggle" data-sidebar-collapsed-value="true" style="border-left: 1px solid var(--admin-border); background-color: var(--admin-bg-primary); height: 100vh; overflow-y: auto;">
      
      <div class="p-6 space-y-8" data-sidebar-target="content" data-controller="sidebar-reorder" data-sidebar-reorder-user-id-value="<%= current_user.id %>" data-sidebar-reorder-target="container">
        
        <!-- 1. Post Section (formerly Publish) -->
        <div class="sidebar-section pb-6 border-b border-gray-100 dark:border-gray-800" data-controller="collapsible" data-collapsible-open-value="true" data-collapsible-section-type-value="post" data-collapsible-user-id-value="<%= current_user.id %>" data-section-type="post">
          <div class="flex items-center gap-2 mb-4">
            <div class="drag-handle cursor-grab active:cursor-grabbing p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
              </svg>
            </div>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="flex-1 text-left text-sm font-medium text-gray-900 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              Post
            </button>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4 transition-transform" data-collapsible-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
              </svg>
            </button>
          </div>
          
          <div data-collapsible-target="content">
            <!-- Featured Image Preview -->
            <div class="featured-image-preview">
              <% if @post.featured_image_file.attached? %>
                <%= image_tag @post.featured_image_file, class: "w-full h-full object-cover" %>
                <div class="featured-image-overlay">
                  <button type="button" class="featured-image-btn featured-image-btn-replace" onclick="document.querySelector('input[type=\"file\"]').click()">Replace</button>
                  <button type="button" class="featured-image-btn featured-image-btn-remove" onclick="removeFeaturedImage()">Remove</button>
                </div>
              <% else %>
                <div class="featured-image-upload-placeholder" onclick="document.querySelector('input[type=\"file\"]').click()">
                  Click to upload featured image
                </div>
              <% end %>
              <%= f.file_field :featured_image_file, class: "hidden", onchange: "previewFeaturedImage(this)" %>
            </div>
            
            <!-- Two-column layout for Post settings -->
            <div class="space-y-3">
              <!-- Status -->
              <div class="post-field-row">
                <label class="post-field-label">Status</label>
                <%= f.select :status, 
                    options_for_select([
                      ['Draft', 'draft'],
                      ['Published', 'published'],
                      ['Scheduled', 'scheduled'],
                      ['Pending Review', 'pending_review'],
                      ['Private', 'private']
                    ], @post.status),
                    {},
                    class: "post-field-input" %>
              </div>
              
              <!-- Publish Date -->
              <div class="post-field-row">
                <label class="post-field-label">Publish</label>
                <%= f.datetime_local_field :published_at, 
                    value: @post.published_at&.strftime('%Y-%m-%dT%H:%M'),
                    class: "post-field-input" %>
              </div>
              
              <!-- Slug -->
              <div class="post-field-row">
                <label class="post-field-label">Slug</label>
                <%= f.text_field :slug, 
                    class: "post-field-input",
                    data: { slug_generator_target: "slug" } %>
              </div>
              
              <!-- Author -->
              <div class="post-field-row">
                <label class="post-field-label">Author</label>
                <%= f.collection_select :user_id, @users, :id, :name, 
                    { selected: @post.user_id || current_user.id },
                    { class: "post-field-input" } %>
              </div>
              
              <!-- Template -->
              <div class="post-field-row">
                <label class="post-field-label">Template</label>
                <%= f.select :template, 
                    options_for_select(@available_templates, @post.template),
                    { include_blank: 'Default' },
                    { class: "post-field-input" } %>
              </div>
              
            </div>
          </div>
        </div>
        
        <!-- 2. Categories & Tags -->
        <div class="sidebar-section pb-6 border-b border-gray-100 dark:border-gray-800" data-controller="collapsible" data-collapsible-open-value="true" data-collapsible-section-type-value="categories-tags" data-collapsible-user-id-value="<%= current_user.id %>" data-section-type="categories-tags">
          <div class="flex items-center gap-2 mb-4">
            <div class="drag-handle cursor-grab active:cursor-grabbing p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
              </svg>
            </div>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="flex-1 text-left text-sm font-medium text-gray-900 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              Categories & Tags
            </button>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4 transition-transform" data-collapsible-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
              </svg>
            </button>
          </div>
          
          <div data-collapsible-target="content">
            <div class="mb-4">
              <label class="block text-xs font-medium mb-2" style="color: var(--admin-text-muted);">Categories</label>
              <%= f.collection_select :category_ids, 
                  @categories, :id, :name,
                  { include_blank: 'Select categories' },
                  { multiple: true, class: "w-full px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none form-control" } %>
            </div>
            
            <div>
              <label class="block text-xs font-medium mb-2" style="color: var(--admin-text-muted);">Tags</label>
              <%= f.text_field :tag_list, 
                  placeholder: "Add tags, comma separated",
                  class: "w-full px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 form-control" %>
              <p class="text-xs text-gray-600 mt-1">Separate tags with commas</p>
            </div>
          </div>
        </div>
        
        <!-- 3. Content Channels -->
        <div class="sidebar-section pb-6 border-b border-gray-100 dark:border-gray-800" data-controller="collapsible" data-collapsible-open-value="true" data-collapsible-section-type-value="content-channels" data-collapsible-user-id-value="<%= current_user.id %>" data-section-type="content-channels">
          <div class="flex items-center gap-2 mb-4">
            <div class="drag-handle cursor-grab active:cursor-grabbing p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5"/>
              </svg>
            </div>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="flex-1 text-left text-sm font-medium text-gray-900 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              Content Channels
            </button>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4 transition-transform" data-collapsible-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
              </svg>
            </button>
          </div>
          
          <div data-collapsible-target="content">
            <div class="content-channels">
              <% if @channels.any? %>
                <% @channels.each do |channel| %>
                  <div class="channel-option">
                    <%= f.check_box :channel_ids, 
                        { multiple: true, checked: @post.channels.include?(channel) }, 
                        channel.id, 
                        nil %>
                    <label class="channel-label" for="post_channel_ids_<%= channel.id %>">
                      <%= channel.name %>
                    </label>
                  </div>
                <% end %>
              <% else %>
                <div class="channel-option">
                  <%= f.check_box :channel_ids, 
                      { multiple: true, checked: true }, 
                      'web', 
                      nil %>
                  <label class="channel-label" for="post_channel_ids_web">
                    Web
                  </label>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        
        <!-- 4. SEO & Meta -->
        <div class="sidebar-section pb-6 border-b border-gray-100 dark:border-gray-800" data-controller="collapsible" data-collapsible-open-value="true" data-collapsible-section-type-value="seo-meta" data-collapsible-user-id-value="<%= current_user.id %>" data-section-type="seo-meta">
          <div class="flex items-center gap-2 mb-4">
            <div class="drag-handle cursor-grab active:cursor-grabbing p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
              </svg>
            </div>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="flex-1 text-left text-sm font-medium text-gray-900 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              SEO & Meta
            </button>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4 transition-transform" data-collapsible-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
              </svg>
            </button>
          </div>
          
          <div data-collapsible-target="content">
            <div class="mb-3">
              <label class="block text-xs font-medium mb-2" style="color: var(--admin-text-muted);">Meta Title</label>
              <%= f.text_field :meta_title, 
                  placeholder: "SEO title",
                  class: "w-full px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 form-control" %>
            </div>
            
            <div class="mb-3">
              <label class="block text-xs font-medium mb-2" style="color: var(--admin-text-muted);">Meta Description</label>
              <%= f.text_area :meta_description, 
                  rows: 2,
                  placeholder: "SEO description",
                  class: "w-full px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none form-control" %>
            </div>
            
            <div>
              <label class="block text-xs font-medium mb-2" style="color: var(--admin-text-muted);">Meta Keywords</label>
              <%= f.text_field :meta_keywords, 
                  placeholder: "keyword1, keyword2, keyword3",
                  class: "w-full px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 form-control" %>
            </div>
          </div>
        </div>
        
        <!-- 5. Excerpt -->
        <div class="sidebar-section pb-6 border-b border-gray-100 dark:border-gray-800" data-controller="collapsible" data-collapsible-open-value="true" data-collapsible-section-type-value="excerpt" data-collapsible-user-id-value="<%= current_user.id %>" data-section-type="excerpt">
          <div class="flex items-center gap-2 mb-4">
            <div class="drag-handle cursor-grab active:cursor-grabbing p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"/>
              </svg>
            </div>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="flex-1 text-left text-sm font-medium text-gray-900 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              Excerpt
            </button>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4 transition-transform" data-collapsible-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
              </svg>
            </button>
          </div>
          
          <div data-collapsible-target="content">
            <%= f.text_area :excerpt, 
                rows: 3,
                placeholder: "Brief description of your post...",
                class: "w-full px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none form-control" %>
            <p class="text-xs text-gray-600 mt-1">Optional. Will be used in previews.</p>
          </div>
        </div>
        
        <!-- 6. Plugin Blocks Added to This Page -->
        <% if plugin_blocks_present?(:post, position: :sidebar, record: @post) %>
        <div class="sidebar-section pb-6 border-b border-gray-100 dark:border-gray-800" data-controller="collapsible" data-collapsible-open-value="true" data-collapsible-section-type-value="plugin-blocks" data-collapsible-user-id-value="<%= current_user.id %>" data-section-type="plugin-blocks">
          <div class="flex items-center gap-2 mb-4">
            <div class="drag-handle cursor-grab active:cursor-grabbing p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z"/>
              </svg>
            </div>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="flex-1 text-left text-sm font-medium text-gray-900 dark:text-white hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              Plugin Blocks
            </button>
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <svg class="w-4 h-4 transition-transform" data-collapsible-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
              </svg>
            </button>
          </div>
          
          <div data-collapsible-target="content">
            <div class="plugin-blocks-section">
              <%= render_plugin_blocks :post, position: :sidebar, record: @post %>
            </div>
          </div>
        </div>
        <% end %>
        
        <!-- Post Info -->
        <% if @post.persisted? %>
          <div>
            <h3 class="text-sm font-semibold mb-4" style="color: var(--color-gray-900);">Post Info</h3>
            <div class="space-y-2 text-xs text-gray-400">
              <div class="flex justify-between">
                <span>Created:</span>
                <span class="text-gray-300"><%= @post.created_at.strftime('%b %d, %Y') %></span>
              </div>
              <div class="flex justify-between">
                <span>Last updated:</span>
                <span class="text-gray-300"><%= @post.updated_at.strftime('%b %d, %Y') %></span>
              </div>
              <div class="flex justify-between">
                <span>Author:</span>
                <span class="text-gray-300"><%= @post.author_name %></span>
              </div>
              <% if @post.views_count.present? %>
                <div class="flex justify-between">
                  <span>Views:</span>
                  <span class="text-gray-300"><%= number_with_delimiter(@post.views_count) %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- Versions -->
        <% if @post.persisted? && @post.versions_count > 0 %>
          <div class="pb-6 border-b border-gray-100 dark:border-gray-800" data-controller="collapsible" data-collapsible-open-value="false">
            <button type="button" 
                    data-action="click->collapsible#toggle" 
                    class="w-full text-left text-sm font-medium text-gray-900 dark:text-white mb-4 flex items-center justify-between hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Versions (<%= @post.versions_count %>)
              </div>
              <svg class="w-4 h-4 text-gray-400 transition-transform" data-collapsible-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/>
              </svg>
            </button>
            
            <div data-collapsible-target="content">
              <div class="space-y-3 max-h-64 overflow-y-auto">
                <% @post.versions.limit(10).each_with_index do |version, index| %>
                  <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                      <div class="text-xs text-gray-600 dark:text-gray-400">
                        <%= version.created_at.strftime('%b %d, %H:%M') %>
                      </div>
                      <% if index == 0 %>
                        <span class="text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-1 rounded-full">Current</span>
                      <% else %>
                        <span class="text-xs bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200 px-2 py-1 rounded-full">v<%= @post.versions_count - index %></span>
                      <% end %>
                    </div>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mb-2">
                      <%= @post.version_summary(version) %>
                    </div>
                    <% if index > 0 %>
                      <%= button_to restore_version_admin_post_path(@post, version_id: version.id), 
                          method: :post,
                          data: { 
                            confirm: 'Restore this version?',
                            turbo_confirm: 'Restore this version?'
                          },
                          class: "w-full px-3 py-1.5 text-xs bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-colors" do %>
                        Restore
                      <% end %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    </div>
  <% end %>
</div>

<!-- Keyboard shortcuts help (toggle with ?) -->
<div id="shortcuts-help" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50" data-keyboard-shortcuts-target="helpPanel" data-action="click->keyboard-shortcuts#hideHelp">
  <div class="bg-white dark:bg-gray-900 rounded-xl p-8 max-w-2xl w-full mx-4 shadow-2xl" onclick="event.stopPropagation()">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white">Keyboard Shortcuts</h3>
      <button data-action="click->keyboard-shortcuts#hideHelp" class="text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">General</p>
        <ul class="space-y-2 text-gray-600 dark:text-gray-400">
          <li><kbd>âŒ˜/Ctrl + S</kbd> - Save</li>
          <li><kbd>âŒ˜/Ctrl + Enter</kbd> - Publish</li>
          <li><kbd>?</kbd> - Show this help</li>
          <li><kbd>Esc</kbd> - Close dialogs</li>
        </ul>
      </div>
      
      <div>
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">Formatting</p>
        <ul class="space-y-2 text-gray-600 dark:text-gray-400">
          <li><kbd>âŒ˜/Ctrl + B</kbd> - Bold</li>
          <li><kbd>âŒ˜/Ctrl + I</kbd> - Italic</li>
          <li><kbd>âŒ˜/Ctrl + U</kbd> - Underline</li>
          <li><kbd>âŒ˜/Ctrl + E</kbd> - Inline Code</li>
        </ul>
      </div>
      
      <div>
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">Blocks</p>
        <ul class="space-y-2 text-gray-600 dark:text-gray-400">
          <li><kbd>âŒ˜ + â‡§ + H</kbd> - Header</li>
          <li><kbd>âŒ˜ + â‡§ + L</kbd> - List</li>
          <li><kbd>âŒ˜ + â‡§ + Q</kbd> - Quote</li>
          <li><kbd>âŒ˜ + â‡§ + C</kbd> - Code Block</li>
        </ul>
      </div>
      
      <div>
        <p class="font-medium text-gray-700 dark:text-gray-300 mb-2">Navigation</p>
        <ul class="space-y-2 text-gray-600 dark:text-gray-400">
          <li><kbd>Tab</kbd> - Indent</li>
          <li><kbd>â‡§ + Tab</kbd> - Outdent</li>
          <li><kbd>Enter</kbd> - New block</li>
          <li><kbd>âŒ«</kbd> - Delete block (if empty)</li>
        </ul>
      </div>
    </div>
    
    <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
      <p class="text-xs text-gray-500 dark:text-gray-400">
        ðŸ’¡ Tip: Type <code>/</code> to see all available blocks
      </p>
    </div>
  </div>
</div>

<!-- Keyboard shortcuts are now handled by the Stimulus controller -->

<script>
// Featured Image Preview Functions
function previewFeaturedImage(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = document.querySelector('.featured-image-preview');
      preview.innerHTML = `
        <img src="${e.target.result}" class="w-full h-full object-cover" />
        <div class="featured-image-overlay">
          <button type="button" class="featured-image-btn featured-image-btn-replace" onclick="document.querySelector('input[type=\"file\"]').click()">Replace</button>
          <button type="button" class="featured-image-btn featured-image-btn-remove" onclick="removeFeaturedImage()">Remove</button>
        </div>
      `;
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function removeFeaturedImage() {
  const preview = document.querySelector('.featured-image-preview');
  const fileInput = document.querySelector('input[type="file"]');
  
  preview.innerHTML = `
    <div class="featured-image-upload-placeholder" onclick="document.querySelector('input[type=\"file\"]').click()">
      Click to upload featured image
    </div>
  `;
  
  // Clear the file input
  fileInput.value = '';
  
  // Trigger change event to update form state
  fileInput.dispatchEvent(new Event('change'));
}
</script>

