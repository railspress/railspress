<!DOCTYPE html>
<html>
<head>
  <title>Template Customizer - <%= @template.name %></title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <%= csrf_meta_tags %>
  
  <!-- GrapesJS CSS -->
  <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
  <link rel="stylesheet" href="https://unpkg.com/grapesjs-preset-webpage/dist/grapesjs-preset-webpage.min.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body, html {
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    
    /* Top Bar */
    .editor-topbar {
      height: 50px;
      background: #1F2937;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .editor-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .editor-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: #3B82F6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563EB;
    }
    
    .btn-secondary {
      background: #6B7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4B5563;
    }
    
    .btn-success {
      background: #10B981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    /* Editor Container */
    .editor-container {
      height: calc(100vh - 50px);
      display: flex;
      flex-direction: column;
    }
    
    /* Panels Row */
    .panels-row {
      display: flex;
      background: #F3F4F6;
      border-bottom: 1px solid #E5E7EB;
      padding: 8px 12px;
      gap: 12px;
      align-items: center;
    }
    
    .panel-section {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    
    .panel-divider {
      width: 1px;
      height: 24px;
      background: #D1D5DB;
      margin: 0 8px;
    }
    
    /* Main Editor Area */
    .editor-main {
      flex: 1;
      display: flex;
      height: calc(100vh - 50px - 48px);
      overflow: hidden;
    }
    
    /* Left Sidebar - Blocks */
    .sidebar-left {
      width: 280px;
      background: #FFFFFF;
      border-right: 1px solid #E5E7EB;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid #E5E7EB;
      background: #F9FAFB;
    }
    
    .sidebar-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #6B7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .sidebar-tab.active {
      color: #3B82F6;
      border-bottom-color: #3B82F6;
      background: #FFFFFF;
    }
    
    .sidebar-tab:hover {
      color: #1F2937;
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
    }
    
    #blocks-container,
    #layers-container {
      padding: 12px;
    }
    
    /* Canvas */
    .canvas-area {
      flex: 1;
      background: #E5E7EB;
      position: relative;
    }
    
    #gjs {
      height: 100%;
      width: 100%;
    }
    
    /* Right Sidebar - Styles & Traits */
    .sidebar-right {
      width: 300px;
      background: #FFFFFF;
      border-left: 1px solid #E5E7EB;
      overflow-y: auto;
    }
    
    .sidebar-right-tabs {
      display: flex;
      border-bottom: 1px solid #E5E7EB;
      background: #F9FAFB;
    }
    
    .sidebar-right-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #6B7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .sidebar-right-tab.active {
      color: #3B82F6;
      border-bottom-color: #3B82F6;
      background: #FFFFFF;
    }
    
    #styles-container,
    #traits-container {
      padding: 12px;
      display: none;
    }
    
    #styles-container.active,
    #traits-container.active {
      display: block;
    }
    
    /* GrapesJS Customization */
    .gjs-block {
      min-height: 50px;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    
    .gjs-block:hover {
      background: #F3F4F6;
    }
    
    .gjs-block-category {
      border-bottom: 1px solid #E5E7EB;
      margin-bottom: 8px;
    }
    
    .gjs-title {
      background: #F9FAFB;
      padding: 8px 12px;
      font-weight: 600;
      font-size: 13px;
      color: #374151;
    }
    
    /* Panel Buttons */
    .gjs-pn-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      cursor: pointer;
      background: #F3F4F6;
      color: #374151;
      border-radius: 4px;
      transition: all 0.2s;
      border: 1px solid #D1D5DB;
      height: 32px;
      min-width: 32px;
    }
    
    .gjs-pn-btn:hover {
      background: #E5E7EB;
      border-color: #9CA3AF;
    }
    
    .gjs-pn-btn.gjs-pn-active {
      background: #3B82F6;
      color: white;
      border-color: #3B82F6;
    }
    
    /* Loading State */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }
    
    .loading-overlay.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div>Loading Editor...</div>
  </div>

  <!-- Top Bar -->
  <div class="editor-topbar">
    <div class="editor-title">
      <svg style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
      </svg>
      <span>Editing: <%= @template.name %> (<%= @template.template_type %>)</span>
    </div>
    <div class="editor-actions">
      <button id="preview-btn" class="btn btn-secondary">
        <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>
        Preview
      </button>
      <button id="save-btn" class="btn btn-success">
        <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Save Template
      </button>
      <%= link_to admin_template_customizer_path, class: 'btn btn-secondary' do %>
        <svg style="width:16px;height:16px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Close
      <% end %>
    </div>
  </div>

  <!-- Editor Container -->
  <div class="editor-container">
    <!-- Panels Row -->
    <div class="panels-row">
      <div id="basic-actions" class="panel-section"></div>
      <div class="panel-divider"></div>
      <div id="devices-panel" class="panel-section"></div>
    </div>
    
    <!-- Main Editor Area -->
    <div class="editor-main">
      <!-- Left Sidebar -->
      <div class="sidebar-left">
        <div class="sidebar-tabs">
          <div class="sidebar-tab active" onclick="switchLeftTab('blocks')">
            <svg style="width:16px;height:16px;display:inline;margin-right:4px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"/>
            </svg>
            Blocks
          </div>
          <div class="sidebar-tab" onclick="switchLeftTab('layers')">
            <svg style="width:16px;height:16px;display:inline;margin-right:4px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
            </svg>
            Layers
          </div>
        </div>
        <div class="sidebar-content">
          <div id="blocks-container"></div>
          <div id="layers-container" style="display:none;"></div>
        </div>
      </div>
      
      <!-- Canvas -->
      <div class="canvas-area">
        <div id="gjs"></div>
      </div>
      
      <!-- Right Sidebar -->
      <div class="sidebar-right">
        <div class="sidebar-right-tabs">
          <div class="sidebar-right-tab active" onclick="switchRightTab('styles')">
            <svg style="width:16px;height:16px;display:inline;margin-right:4px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
            </svg>
            Styles
          </div>
          <div class="sidebar-right-tab" onclick="switchRightTab('traits')">
            <svg style="width:16px;height:16px;display:inline;margin-right:4px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
            </svg>
            Settings
          </div>
        </div>
        <div id="styles-container" class="active"></div>
        <div id="traits-container"></div>
      </div>
    </div>
  </div>

  <!-- GrapesJS Scripts -->
  <script src="https://unpkg.com/grapesjs"></script>
  <script src="https://unpkg.com/grapesjs-preset-webpage"></script>
  <script src="https://unpkg.com/grapesjs-blocks-basic"></script>

  <script>
    // Tab switching functions
    function switchLeftTab(tab) {
      // Update tabs
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      event.target.closest('.sidebar-tab').classList.add('active');
      
      // Show/hide containers
      document.getElementById('blocks-container').style.display = tab === 'blocks' ? 'block' : 'none';
      document.getElementById('layers-container').style.display = tab === 'layers' ? 'block' : 'none';
    }
    
    function switchRightTab(tab) {
      // Update tabs
      document.querySelectorAll('.sidebar-right-tab').forEach(t => t.classList.remove('active'));
      event.target.closest('.sidebar-right-tab').classList.add('active');
      
      // Show/hide containers
      document.getElementById('styles-container').classList.toggle('active', tab === 'styles');
      document.getElementById('traits-container').classList.toggle('active', tab === 'traits');
    }
    
    // Initialize GrapesJS
    window.addEventListener('DOMContentLoaded', function() {
      // Check if already initialized
      if (window.railspressEditor) {
        window.railspressEditor.destroy();
      }
      
      // Check if GrapesJS is loaded
      if (typeof grapesjs === 'undefined') {
        console.error('GrapesJS not loaded');
        document.getElementById('loading-overlay').innerHTML = '<div>Error: GrapesJS failed to load. Please refresh.</div>';
        return;
      }
      
      // Initialize editor
      const editor = window.railspressEditor = grapesjs.init({
        container: '#gjs',
        height: '100%',
        width: 'auto',
        storageManager: false,
        
        // Load content
        components: <%= raw @template.html_content.to_json %>,
        style: <%= raw @template.css_content.to_json %>,
        
        // Canvas
        canvas: {
          styles: [
            'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css'
          ],
          scripts: []
        },
        
        // Block Manager
        blockManager: {
          appendTo: '#blocks-container',
          blocks: []
        },
        
        // Layer Manager  
        layerManager: {
          appendTo: '#layers-container'
        },
        
        // Style Manager
        styleManager: {
          appendTo: '#styles-container',
          sectors: [
            {
              name: 'Typography',
              open: true,
              buildProps: ['font-family', 'font-size', 'font-weight', 'line-height', 'letter-spacing', 'color', 'text-align', 'text-decoration', 'text-transform']
            },
            {
              name: 'Dimensions',
              open: false,
              buildProps: ['width', 'height', 'max-width', 'min-height', 'margin', 'padding']
            },
            {
              name: 'Background',
              open: false,
              buildProps: ['background-color', 'background-image', 'background-repeat', 'background-position', 'background-size']
            },
            {
              name: 'Border',
              open: false,
              buildProps: ['border', 'border-radius', 'border-width', 'border-style', 'border-color']
            },
            {
              name: 'Effects',
              open: false,
              buildProps: ['opacity', 'box-shadow', 'transform', 'transition']
            },
            {
              name: 'Layout',
              open: false,
              buildProps: ['display', 'position', 'top', 'right', 'bottom', 'left', 'flex-direction', 'justify-content', 'align-items', 'flex-wrap', 'gap']
            }
          ]
        },
        
        // Trait Manager
        traitManager: {
          appendTo: '#traits-container'
        },
        
        // Selector Manager
        selectorManager: {
          appendTo: '#styles-container'
        },
        
        // Devices
        deviceManager: {
          devices: [
            { name: 'Desktop', width: '' },
            { name: 'Tablet', width: '768px', widthMedia: '992px' },
            { name: 'Mobile', width: '320px', widthMedia: '480px' }
          ]
        },
        
        // Panels - Empty, we'll add custom ones
        panels: {
          defaults: []
        },
        
        // Plugins
        plugins: ['gjs-preset-webpage', 'gjs-blocks-basic'],
        pluginsOpts: {
          'gjs-preset-webpage': {
            blocksBasicOpts: {
              blocks: ['column1', 'column2', 'column3', 'column3-7', 'text', 'link', 'image', 'video', 'map'],
              flexGrid: 1,
            },
            blocks: ['link-block', 'quote', 'text-basic'],
            modalImportTitle: 'Import',
            modalImportLabel: '<div style="margin-bottom: 10px; font-size: 13px;">Paste your HTML/CSS here</div>',
            modalImportContent: function(editor) {
              return editor.getHtml() + '<style>' + editor.getCss() + '</style>';
            },
            importPlaceholder: '<table class="table"><tr><td>Hello</td></tr></table>',
            cellStyle: {
              'min-height': '75px',
            }
          }
        }
      });
      
      // Add custom panels
      editor.Panels.addPanel({
        id: 'basic-actions',
        el: '#basic-actions',
        buttons: [
          {
            id: 'visibility',
            active: true,
            className: 'gjs-pn-btn',
            label: '<svg style="width:18px;height:18px" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>',
            command: 'sw-visibility',
            attributes: { title: 'Toggle borders' }
          },
          {
            id: 'fullscreen',
            className: 'gjs-pn-btn',
            label: '<svg style="width:18px;height:18px" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" clip-rule="evenodd"/></svg>',
            command: 'fullscreen',
            attributes: { title: 'Fullscreen' }
          },
          {
            id: 'undo',
            className: 'gjs-pn-btn',
            label: '<svg style="width:18px;height:18px" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>',
            command: 'core:undo',
            attributes: { title: 'Undo' }
          },
          {
            id: 'redo',
            className: 'gjs-pn-btn',
            label: '<svg style="width:18px;height:18px" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>',
            command: 'core:redo',
            attributes: { title: 'Redo' }
          },
          {
            id: 'clear-all',
            className: 'gjs-pn-btn',
            label: '<svg style="width:18px;height:18px" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
            command: 'core:canvas-clear',
            attributes: { title: 'Clear canvas' }
          }
        ]
      });
      
      // Add devices panel
      editor.Panels.addPanel({
        id: 'devices',
        el: '#devices-panel',
        buttons: [
          {
            id: 'device-desktop',
            className: 'gjs-pn-btn',
            label: '<svg style="width:18px;height:18px" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"/></svg>',
            command: 'set-device-desktop',
            active: true,
            attributes: { title: 'Desktop view' }
          },
          {
            id: 'device-tablet',
            className: 'gjs-pn-btn',
            label: '<svg style="width:18px;height:18px" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm4 14a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>',
            command: 'set-device-tablet',
            attributes: { title: 'Tablet view' }
          },
          {
            id: 'device-mobile',
            className: 'gjs-pn-btn',
            label: '<svg style="width:18px;height:18px" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7zm3 14a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>',
            command: 'set-device-mobile',
            attributes: { title: 'Mobile view' }
          }
        ]
      });
      
      // Device commands
      editor.Commands.add('set-device-desktop', {
        run: editor => editor.setDevice('Desktop')
      });
      editor.Commands.add('set-device-tablet', {
        run: editor => editor.setDevice('Tablet')
      });
      editor.Commands.add('set-device-mobile', {
        run: editor => editor.setDevice('Mobile')
      });
      
      // Custom WordPress-like blocks
      editor.BlockManager.add('post-title', {
        label: 'Post Title',
        category: 'WordPress',
        content: '<h1 class="text-4xl font-bold mb-4">{{post.title}}</h1>',
        attributes: { class: 'gjs-block' }
      });
      
      editor.BlockManager.add('post-content', {
        label: 'Post Content',
        category: 'WordPress',
        content: '<div class="prose max-w-none">{{post.content}}</div>',
        attributes: { class: 'gjs-block' }
      });
      
      editor.BlockManager.add('post-excerpt', {
        label: 'Post Excerpt',
        category: 'WordPress',
        content: '<p class="text-lg text-gray-600">{{post.excerpt}}</p>',
        attributes: { class: 'gjs-block' }
      });
      
      // Save functionality
      document.getElementById('save-btn').addEventListener('click', function() {
        const html = editor.getHtml();
        const css = editor.getCss();
        const js = editor.getJs();
        
        document.getElementById('loading-overlay').classList.remove('hidden');
        document.getElementById('loading-overlay').innerHTML = '<div>Saving...</div>';
        
        fetch('<%= admin_update_template_path(@template) %>', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '<%= form_authenticity_token %>',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            template: {
              html_content: html,
              css_content: css,
              js_content: js
            }
          })
        })
        .then(response => response.json())
        .then(data => {
          document.getElementById('loading-overlay').classList.add('hidden');
          if (data.success) {
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMsg.textContent = '✓ Template saved successfully!';
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
          } else {
            alert('Error: ' + (data.errors ? data.errors.join(', ') : 'Unknown error'));
          }
        })
        .catch(error => {
          document.getElementById('loading-overlay').classList.add('hidden');
          console.error('Save error:', error);
          alert('Failed to save template');
        });
      });
      
      // Preview functionality
      document.getElementById('preview-btn').addEventListener('click', function() {
        editor.runCommand('preview');
      });
      
      // Hide loading overlay
      document.getElementById('loading-overlay').classList.add('hidden');
      
      console.log('✓ GrapesJS Editor initialized successfully');
    });
  </script>
</body>
</html>
