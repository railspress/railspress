<script>
  // Global Tabulator + Turbo fix
  // This script ensures Tabulator tables work correctly with Turbo navigation
  
  (function() {
    // Track all initialized tables
    const tables = new Map();
    
    // Initialize or reinitialize table
    window.initTabulatorTable = function(elementId, config) {
      const element = document.getElementById(elementId);
      if (!element) return null;
      
      // Destroy existing table if present
      if (tables.has(elementId)) {
        tables.get(elementId).destroy();
        tables.delete(elementId);
      }
      
      // Create new table
      try {
        const table = new Tabulator(`#${elementId}`, config);
        tables.set(elementId, table);
        return table;
      } catch (error) {
        console.error(`Error initializing Tabulator table ${elementId}:`, error);
        return null;
      }
    };
    
    // Cleanup before caching
    document.addEventListener('turbo:before-cache', function() {
      tables.forEach((table, elementId) => {
        try {
          table.destroy();
        } catch (error) {
          console.error(`Error destroying table ${elementId}:`, error);
        }
      });
      tables.clear();
    });
    
    // Cleanup before render (when navigating away)
    document.addEventListener('turbo:before-render', function() {
      tables.forEach((table, elementId) => {
        try {
          table.destroy();
        } catch (error) {
          console.error(`Error destroying table ${elementId}:`, error);
        }
      });
      tables.clear();
    });
  })();
</script>





