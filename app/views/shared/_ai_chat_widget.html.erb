<%
  # Default values
  background_color = local_assigns[:background_color] || '#1a1a1a'
  user_bubble_color = local_assigns[:user_bubble_color] || '#4F46E5'
  agent_bubble_color = local_assigns[:agent_bubble_color] || '#2a2a2a'
  accent_color = local_assigns[:accent_color] || '#4F46E5'
  height = local_assigns[:height] || '600px'
  agent_slug = local_assigns[:agent_slug]
  title = local_assigns[:title] || 'AI Assistant'
  target_selector = local_assigns[:target_selector]
  insert_callback = local_assigns[:insert_callback]
  display_html_raw = local_assigns[:display_html_raw] || false
  recall_conversation = local_assigns[:recall_conversation] || false
  show_greeting = local_assigns[:show_greeting] || true
  show_settings = local_assigns[:show_settings] || false
  settings_mode = local_assigns[:settings_mode] || 'basic' # 'basic' or 'advanced'
  add_content = local_assigns[:add_content] || false
  show_close_button = local_assigns[:show_close_button] != false # default true
  close_button_callback = local_assigns[:close_button_callback]
  allow_attachments = local_assigns[:allow_attachments] || false
  allow_agent_switch = local_assigns[:allow_agent_switch] || false
  clear_conversation_on_switch = local_assigns[:clear_conversation_on_switch] || false
  
  # Avatar and user settings
  user_avatar_url = local_assigns[:user_avatar_url] || nil
  bot_avatar_url = local_assigns[:bot_avatar_url] || nil
  user_name = local_assigns[:user_name] || nil
  user_id = local_assigns[:user_id] || nil
  user_email = local_assigns[:user_email] || nil
  user_role = local_assigns[:user_role] || nil
  
  # Widget styling settings
  rounded_corners = local_assigns[:rounded_corners] || true
  header_color = local_assigns[:header_color] || nil
  textbar_color = local_assigns[:textbar_color] || nil
  
  # Raise error if agent_slug is not provided
  raise "agent_slug is required" unless agent_slug
%>

<div class="ai-chat-widget"
     data-controller="ai-chat-widget"
     data-ai-chat-widget-agent-slug-value="<%= agent_slug %>"
     <% if target_selector %>data-ai-chat-widget-target-selector-value="<%= target_selector %>"<% end %>
     <% if insert_callback %>data-ai-chat-widget-insert-callback-value="<%= insert_callback %>"<% end %>
    data-ai-chat-widget-recall-conversation-value="<%= recall_conversation %>"
    data-ai-chat-widget-show-greeting-value="<%= show_greeting %>"
    data-ai-chat-widget-show-settings-value="<%= show_settings %>"
    data-ai-chat-widget-add-content-value="<%= add_content %>"
    data-ai-chat-widget-allow-attachments-value="<%= allow_attachments %>"
    data-ai-chat-widget-allow-agent-switch-value="<%= allow_agent_switch %>"
    data-ai-chat-widget-show-close-button-value="<%= show_close_button %>"
    data-ai-chat-widget-clear-conversation-on-switch-value="<%= clear_conversation_on_switch %>"
    <% if close_button_callback %>data-ai-chat-widget-close-button-callback-value="<%= close_button_callback %>"<% end %>
    data-ai-chat-widget-background-color-value="<%= background_color %>"
     data-ai-chat-widget-user-bubble-color-value="<%= user_bubble_color %>"
     data-ai-chat-widget-agent-bubble-color-value="<%= agent_bubble_color %>"
     data-ai-chat-widget-accent-color-value="<%= accent_color %>"
     data-ai-chat-widget-display-html-raw-value="<%= display_html_raw %>"
     <% if user_avatar_url %>data-ai-chat-widget-user-avatar-url-value="<%= user_avatar_url %>"<% end %>
     <% if bot_avatar_url %>data-ai-chat-widget-bot-avatar-url-value="<%= bot_avatar_url %>"<% end %>
     <% if user_name %>data-ai-chat-widget-user-name-value="<%= user_name %>"<% end %>
     <% if user_id %>data-ai-chat-widget-user-id-value="<%= user_id %>"<% end %>
     <% if user_email %>data-ai-chat-widget-user-email-value="<%= user_email %>"<% end %>
     <% if user_role %>data-ai-chat-widget-user-role-value="<%= user_role %>"<% end %>
     <% if header_color %>data-ai-chat-widget-header-color-value="<%= header_color %>"<% end %>
     <% if textbar_color %>data-ai-chat-widget-textbar-color-value="<%= textbar_color %>"<% end %>
     style="--chat-height: <%= height %>;<% if !rounded_corners %>--chat-border-radius: 0;<% end %>"
     class="<%= 'no-rounded-corners' unless rounded_corners %>">
  
  <div class="ai-chat-header" data-ai-chat-widget-target="header">
    <h3 class="ai-chat-title"><%= title %></h3>
    <div class="ai-chat-header-actions">
      <% if show_settings %>
      <button type="button" 
              class="ai-chat-settings-btn"
              data-action="click->ai-chat-widget#toggleSettings"
              title="Settings">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </button>
      <% end %>
      <div class="ai-chat-menu-wrapper">
        <button type="button" 
                class="ai-chat-menu-btn"
                data-action="click->ai-chat-widget#toggleMenu"
                title="Menu">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <circle cx="5" cy="12" r="1.5" />
            <circle cx="12" cy="12" r="1.5" />
            <circle cx="19" cy="12" r="1.5" />
          </svg>
        </button>
        <div class="ai-chat-menu" data-ai-chat-widget-target="menu" style="display: none;">
          <button type="button" 
                  class="ai-chat-menu-item"
                  data-action="click->ai-chat-widget#newChat">
            New Chat
          </button>
          <button type="button" 
                  class="ai-chat-menu-item"
                  data-action="click->ai-chat-widget#downloadTranscript">
            Download Transcript
          </button>
        </div>
      </div>
      <% if show_close_button %>
      <button type="button" 
              class="ai-chat-close"
              data-action="click->ai-chat-widget#closeWidget"
              title="Close">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <% end %>
    </div>
  </div>
  
  <div class="ai-chat-messages" data-ai-chat-widget-target="messages">
    <!-- Messages will be added here dynamically -->
  </div>
  
  <% if allow_attachments %>
  <!-- Attached Files Chips -->
  <div class="ai-chat-attachments" data-ai-chat-widget-target="attachmentChips" style="display: none;">
    <!-- Attachment chips will be added here dynamically -->
  </div>
  <% end %>
  
  <div class="ai-chat-input-area">
    <div class="ai-chat-input-wrapper">
      <textarea 
        class="ai-chat-input"
        data-ai-chat-widget-target="input"
        placeholder="Type your message..."
        rows="1"
        data-action="keydown->ai-chat-widget#handleKeyDown"></textarea>
      <div class="ai-chat-input-right-buttons">
        <% if add_content %>
        <button type="button"
                class="ai-chat-content-btn"
                data-action="click->ai-chat-widget#toggleContent"
                title="Additional Content">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </button>
        <% end %>
        <% if allow_attachments %>
        <button type="button"
                class="ai-chat-attach-btn"
                data-action="click->ai-chat-widget#openAttachmentModal"
                title="Attach file">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        </button>
        <% end %>
        <button 
          type="button"
          class="ai-chat-send"
          data-ai-chat-widget-target="send"
          data-action="click->ai-chat-widget#sendMessage">
          Send
        </button>
      </div>
    </div>
    
    <% if target_selector %>
    <div class="ai-chat-actions">
      <button 
        type="button"
        class="ai-chat-action-btn"
        data-action="click->ai-chat-widget#insertToTarget">
        Insert to Editor
      </button>
    </div>
    <% end %>
  </div>
  
  <% if show_settings %>
  <!-- Settings Overlay -->
  <div class="ai-chat-settings-overlay" data-ai-chat-widget-target="settingsOverlay" style="display: none;">
    <div class="ai-chat-settings-content">
      <h4 class="ai-chat-settings-title">Settings</h4>
      
      <% if allow_agent_switch %>
      <!-- Agent -->
      <div class="ai-chat-settings-field">
        <label for="ai-chat-setting-agent">Agent</label>
        <select id="ai-chat-setting-agent" 
                class="ai-chat-settings-select"
                data-ai-chat-widget-target="settingAgent">
          <!-- Options will be populated by JavaScript -->
        </select>
      </div>
      <% end %>
      
      <!-- Tone -->
      <div class="ai-chat-settings-field">
        <label for="ai-chat-setting-tone">Tone</label>
        <select id="ai-chat-setting-tone" 
                class="ai-chat-settings-select"
                data-ai-chat-widget-target="settingTone">
          <option value="balanced">Balanced</option>
          <option value="professional">Professional</option>
          <option value="casual">Casual</option>
          <option value="funny">Funny</option>
          <option value="friendly">Friendly</option>
          <option value="formal">Formal</option>
        </select>
      </div>
      
      <!-- Length -->
      <div class="ai-chat-settings-field">
        <label for="ai-chat-setting-length">Length</label>
        <select id="ai-chat-setting-length" 
                class="ai-chat-settings-select"
                data-ai-chat-widget-target="settingLength">
          <option value="short">Short</option>
          <option value="medium">Medium</option>
          <option value="long">Long</option>
        </select>
      </div>
      
      <% if settings_mode == 'advanced' %>
      <!-- Advanced Fields (visible by default in advanced mode) -->
      <div class="ai-chat-settings-advanced" data-ai-chat-widget-target="advancedFields" style="display: block;">
        <!-- Temperature -->
        <div class="ai-chat-settings-field">
          <label for="ai-chat-setting-temperature">Temperature</label>
          <input type="range" 
                 id="ai-chat-setting-temperature" 
                 min="0" 
                 max="1" 
                 step="0.1" 
                 value="0.7"
                 class="ai-chat-settings-range"
                 data-ai-chat-widget-target="settingTemperature">
          <span class="ai-chat-settings-value" data-ai-chat-widget-target="temperatureValue">0.7</span>
        </div>
        
        <!-- Max Tokens -->
        <div class="ai-chat-settings-field">
          <label for="ai-chat-setting-max-tokens">Max Tokens</label>
          <input type="number" 
                 id="ai-chat-setting-max-tokens" 
                 min="100" 
                 max="4000" 
                 step="100" 
                 value="1000"
                 class="ai-chat-settings-input"
                 data-ai-chat-widget-target="settingMaxTokens">
        </div>
      </div>
      <% end %>
      
      <!-- Actions -->
      <div class="ai-chat-settings-actions">
        <button type="button" 
                class="ai-chat-settings-close"
                data-action="click->ai-chat-widget#closeSettings">
          Close
        </button>
        <button type="button" 
                class="ai-chat-settings-save"
                data-action="click->ai-chat-widget#saveSettings">
          Save
        </button>
      </div>
    </div>
  </div>
  <% end %>
  
  <% if add_content %>
  <!-- Content Overlay -->
  <div class="ai-chat-content-overlay" data-ai-chat-widget-target="contentOverlay" style="display: none;">
    <div class="ai-chat-content-content">
      <h4 class="ai-chat-content-title">Additional Content</h4>
      
      <!-- Content Textarea -->
      <textarea 
        id="ai-chat-content-textarea"
        class="ai-chat-content-textarea"
        data-ai-chat-widget-target="contentTextarea"
        placeholder="Enter additional content, rules, guidelines, etc."
        rows="8"></textarea>
      
      <!-- Actions -->
      <div class="ai-chat-content-actions">
        <button type="button" 
                class="ai-chat-content-close"
                data-action="click->ai-chat-widget#closeContent">
          Close
        </button>
        <button type="button" 
                class="ai-chat-content-save"
                data-action="click->ai-chat-widget#saveContent">
          Save
        </button>
      </div>
    </div>
  </div>
  <% end %>
  
  <% if allow_attachments %>
  <!-- Attachment Modal -->
  <div class="ai-chat-attach-modal" data-ai-chat-widget-target="attachModal" style="display: none;">
    <div class="ai-chat-attach-content">
      <h4 class="ai-chat-attach-title">Attach Files</h4>
      
      <!-- File Input -->
      <div class="ai-chat-attach-dropzone">
        <input type="file"
               id="ai-chat-attach-input"
               class="ai-chat-attach-input"
               data-ai-chat-widget-target="attachInput"
               accept="image/*,application/pdf,text/plain,.docx,.heic,.heif"
               multiple
               data-action="change->ai-chat-widget#handleFileSelect">
        <label for="ai-chat-attach-input" class="ai-chat-attach-label">
          <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <span>Click to upload or drag and drop</span>
          <span class="ai-chat-attach-hint">PDF, TXT, DOCX, Images (Max 5MB)</span>
        </label>
      </div>
      
      <!-- File List -->
      <div class="ai-chat-attach-file-list" data-ai-chat-widget-target="attachedFilesList">
        <!-- Files will be added here dynamically -->
      </div>
      
      <!-- Actions -->
      <div class="ai-chat-attach-actions">
        <button type="button" 
                class="ai-chat-attach-close"
                data-action="click->ai-chat-widget#closeAttachmentModal">
          Close
        </button>
      </div>
    </div>
  </div>
  <% end %>
</div>

